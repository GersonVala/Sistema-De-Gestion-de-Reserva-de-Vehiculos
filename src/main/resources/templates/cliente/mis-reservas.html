<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Reservas - Cliente</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto;
            background: linear-gradient(180deg, #f7fbff 0%, #f0f5ff 100%);
            min-height: 100vh;
            padding: 2rem;
        }
        .container-main {
            max-width: 1400px;
            margin: 0 auto;
        }
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 12px 30px rgba(13, 18, 43, 0.06);
            margin-bottom: 1.5rem;
        }
        .card-header {
            background: linear-gradient(135deg, #2b6ef6 0%, #7b4de2 100%);
            color: white;
            border-radius: 12px 12px 0 0 !important;
            padding: 1.5rem;
        }
        .badge-pendiente {
            background: #fbbf24;
            color: #78350f;
            padding: 0.5rem 0.75rem;
            border-radius: 20px;
        }
        .badge-aceptada {
            background: #34d399;
            color: #065f46;
            padding: 0.5rem 0.75rem;
            border-radius: 20px;
        }
        .badge-cancelada {
            background: #f87171;
            color: #7f1d1d;
            padding: 0.5rem 0.75rem;
            border-radius: 20px;
        }
        .table-hover tbody tr:hover {
            background-color: #f0f5ff;
        }
        .reservation-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        .reservation-card:hover {
            box-shadow: 0 8px 16px rgba(13, 18, 43, 0.1);
        }
        .reservation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .reservation-id {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }
        .reservation-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .detail-item {
            display: flex;
            flex-direction: column;
        }
        .detail-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }
        .detail-value {
            font-weight: 500;
            color: #1f2937;
        }
        .vehicle-info {
            background: #f0f5ff;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .vehicle-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2b6ef6;
            margin-bottom: 0.25rem;
        }
        .price-total {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2b6ef6;
        }
        .btn-cancel {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.5rem 1.25rem;
        }
        .btn-cancel:hover {
            background: #dc2626;
            color: white;
        }
        .filter-pills .btn {
            border-radius: 20px;
            padding: 0.5rem 1.2rem;
        }
        .filter-pills .btn.active {
            background: linear-gradient(135deg, #2b6ef6 0%, #7b4de2 100%);
            color: white;
            border: none;
        }
    </style>
</head>
<body>
    <div class="container container-main">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/cliente/dashboard}">Dashboard</a></li>
                <li class="breadcrumb-item active" aria-current="page">Mis Reservas</li>
            </ol>
        </nav>

        <!-- Header Card -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                    <div>
                        <h4 class="mb-0">
                            <i class="bi bi-calendar-check-fill me-2"></i>
                            Mis Reservas
                        </h4>
                        <small>Gestiona tus reservas y consulta su estado</small>
                    </div>
                    <div class="d-flex gap-2 mt-2 mt-md-0">
                        <a th:href="@{/cliente/vehiculos}" class="btn btn-light btn-sm">
                            <i class="bi bi-car-front me-1"></i>
                            Buscar Vehículos
                        </a>
                        <a th:href="@{/cliente/dashboard}" class="btn btn-light btn-sm">
                            <i class="bi bi-arrow-left me-1"></i>
                            Volver
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mensajes flash -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>
            <span th:text="${success}">Operación exitosa</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <span th:text="${error}">Error</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <!-- Filtros por estado -->
        <div class="mb-4">
            <h6 class="mb-3">Filtrar por estado:</h6>
            <div class="filter-pills d-flex gap-2 flex-wrap">
                <a th:href="@{/cliente/mis-reservas}"
                   class="btn btn-outline-primary active">
                    <i class="bi bi-list-ul me-1"></i>
                    Todas (<span th:text="${#lists.size(reservas)}">0</span>)
                </a>
                <a href="#" onclick="filterByStatus('PENDIENTE'); return false;"
                   class="btn btn-outline-warning">
                    <i class="bi bi-clock-history me-1"></i>
                    Pendientes
                </a>
                <a href="#" onclick="filterByStatus('ACEPTADA'); return false;"
                   class="btn btn-outline-success">
                    <i class="bi bi-check-circle me-1"></i>
                    Aceptadas
                </a>
                <a href="#" onclick="filterByStatus('CANCELADA'); return false;"
                   class="btn btn-outline-danger">
                    <i class="bi bi-x-circle me-1"></i>
                    Canceladas
                </a>
            </div>
        </div>

        <!-- Contador de reservas -->
        <div class="alert alert-info mb-4" role="alert">
            <i class="bi bi-info-circle me-2"></i>
            Tienes <strong th:text="${#lists.size(reservas)}">0</strong> reserva(s) en total
        </div>

        <!-- Reservation Cards -->
        <div th:if="${!#lists.isEmpty(reservas)}">
            <div th:each="reserva : ${reservas}"
                 class="reservation-card"
                 th:attr="data-estado=${reserva.estado.name()}">

                <!-- Header: ID y Estado -->
                <div class="reservation-header">
                    <div class="reservation-id">
                        <i class="bi bi-bookmark-fill me-2" style="color: #2b6ef6;"></i>
                        Reserva #<span th:text="${reserva.idReserva}">1</span>
                    </div>
                    <span class="badge"
                          th:classappend="${reserva.estado.name() == 'PENDIENTE' ? 'badge-pendiente' :
                                          (reserva.estado.name() == 'ACEPTADA' ? 'badge-aceptada' : 'badge-cancelada')}"
                          th:text="${reserva.estado.name()}">
                        PENDIENTE
                    </span>
                </div>

                <!-- Vehicle Info -->
                <div class="vehicle-info">
                    <div class="vehicle-name">
                        <i class="bi bi-car-front-fill me-2"></i>
                        <span th:text="${reserva.vehiculoMarca + ' ' + reserva.vehiculoModelo}">Toyota Corolla</span>
                    </div>
                    <div class="text-muted small">
                        <i class="bi bi-credit-card-2-front me-1"></i>
                        Patente: <span th:text="${reserva.vehiculoPatente}">ABC123</span>
                    </div>
                </div>

                <!-- Reservation Details -->
                <div class="reservation-details">
                    <!-- Fechas -->
                    <div class="detail-item">
                        <div class="detail-label">
                            <i class="bi bi-calendar-event me-1"></i>
                            Fecha de Inicio
                        </div>
                        <div class="detail-value" th:text="${#temporals.format(reserva.fechaInicio, 'dd/MM/yyyy')}">
                            01/01/2024
                        </div>
                    </div>

                    <div class="detail-item">
                        <div class="detail-label">
                            <i class="bi bi-calendar-check me-1"></i>
                            Fecha de Fin
                        </div>
                        <div class="detail-value" th:text="${#temporals.format(reserva.fechaFin, 'dd/MM/yyyy')}">
                            10/01/2024
                        </div>
                    </div>

                    <div class="detail-item">
                        <div class="detail-label">
                            <i class="bi bi-hourglass-split me-1"></i>
                            Duración
                        </div>
                        <div class="detail-value">
                            <span th:text="${reserva.dias}">9</span> días
                        </div>
                    </div>

                    <!-- Sucursales -->
                    <div class="detail-item">
                        <div class="detail-label">
                            <i class="bi bi-box-arrow-up-right text-success me-1"></i>
                            Sucursal de Retiro
                        </div>
                        <div class="detail-value" th:text="${reserva.sucursalRetiroNombre}">
                            Sucursal Centro
                        </div>
                        <small class="text-muted" th:text="${reserva.sucursalRetiroDireccion}">
                            Av. Principal 123
                        </small>
                    </div>

                    <div class="detail-item">
                        <div class="detail-label">
                            <i class="bi bi-box-arrow-in-down text-primary me-1"></i>
                            Sucursal de Devolución
                        </div>
                        <div class="detail-value" th:text="${reserva.sucursalDevolucionNombre}">
                            Sucursal Norte
                        </div>
                        <small class="text-muted" th:text="${reserva.sucursalDevolucionDireccion}">
                            Av. Norte 456
                        </small>
                    </div>

                    <!-- Método de Pago -->
                    <div class="detail-item">
                        <div class="detail-label">
                            <i class="bi bi-credit-card me-1"></i>
                            Método de Pago
                        </div>
                        <div class="detail-value">
                            <span th:switch="${reserva.metodoPago.name()}">
                                <span th:case="'TRANSFERENCIA'">
                                    <i class="bi bi-bank text-primary me-1"></i> Transferencia
                                </span>
                                <span th:case="'TARJETA'">
                                    <i class="bi bi-credit-card text-success me-1"></i> Tarjeta
                                </span>
                                <span th:case="'EFECTIVO'">
                                    <i class="bi bi-cash text-warning me-1"></i> Efectivo
                                </span>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Precio y Acciones -->
                <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                    <div>
                        <div class="text-muted small">Precio Total</div>
                        <div class="price-total">
                            $<span th:text="${#numbers.formatDecimal(reserva.precio, 1, 'COMMA', 2, 'POINT')}">0.00</span>
                        </div>
                    </div>

                    <div class="d-flex gap-2 align-items-center">
                        <!-- Botón Cancelar (solo si está PENDIENTE) -->
                        <form th:if="${reserva.estado.name() == 'PENDIENTE'}"
                              th:action="@{/cliente/reservas/{id}/cancelar(id=${reserva.idReserva})}"
                              method="post"
                              onsubmit="return confirm('¿Está seguro de cancelar esta reserva?');">
                            <button type="submit" class="btn btn-cancel">
                                <i class="bi bi-x-circle me-1"></i>
                                Cancelar Reserva
                            </button>
                        </form>

                        <!-- Mensaje si ya fue procesada -->
                        <div th:if="${reserva.estado.name() == 'ACEPTADA'}" class="text-success">
                            <i class="bi bi-check-circle-fill me-1"></i>
                            <strong>Reserva Confirmada</strong> - El vehículo ha sido entregado
                        </div>

                        <div th:if="${reserva.estado.name() == 'CANCELADA'}" class="text-danger">
                            <i class="bi bi-x-circle-fill me-1"></i>
                            <strong>Reserva Cancelada</strong>
                        </div>
                    </div>
                </div>

                <!-- Info adicional según estado -->
                <div th:if="${reserva.estado.name() == 'PENDIENTE'}" class="alert alert-warning mt-3 mb-0" role="alert">
                    <i class="bi bi-clock-history me-2"></i>
                    <small>
                        Esta reserva está pendiente de confirmación por el vendedor.
                        Puedes cancelarla mientras esté en este estado.
                    </small>
                </div>
            </div>
        </div>

        <!-- Mensaje si no hay reservas -->
        <div th:if="${#lists.isEmpty(reservas)}" class="text-center py-5">
            <i class="bi bi-inbox" style="font-size: 4rem; color: #cbd5e1;"></i>
            <h5 class="mt-3 text-muted">No tienes reservas</h5>
            <p class="text-muted">
                Aún no has realizado ninguna reserva. Explora nuestro catálogo de vehículos y reserva uno ahora.
            </p>
            <a th:href="@{/cliente/vehiculos}" class="btn btn-primary mt-3">
                <i class="bi bi-car-front me-1"></i>
                Buscar Vehículos
            </a>
        </div>

        <!-- Estadísticas rápidas -->
        <div th:if="${!#lists.isEmpty(reservas)}" class="mt-4 p-3 bg-light rounded">
            <div class="row text-center">
                <div class="col-md-4">
                    <div class="fw-bold text-warning">Pendientes</div>
                    <div th:text="${#lists.size(reservas.?[estado.name() == 'PENDIENTE'])}">0</div>
                </div>
                <div class="col-md-4">
                    <div class="fw-bold text-success">Aceptadas</div>
                    <div th:text="${#lists.size(reservas.?[estado.name() == 'ACEPTADA'])}">0</div>
                </div>
                <div class="col-md-4">
                    <div class="fw-bold text-danger">Canceladas</div>
                    <div th:text="${#lists.size(reservas.?[estado.name() == 'CANCELADA'])}">0</div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center text-muted small mt-4">
            <i class="bi bi-info-circle me-1"></i>
            Solo puedes cancelar reservas en estado PENDIENTE. Una vez aceptadas, contacta con la sucursal.
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Filtrado por estado en cliente -->
    <script>
        function filterByStatus(status) {
            const cards = document.querySelectorAll('.reservation-card');
            const buttons = document.querySelectorAll('.filter-pills .btn');

            cards.forEach(card => {
                if (status === 'ALL' || card.dataset.estado === status) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });

            // Update active button
            buttons.forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Función para mostrar todas
        document.querySelector('.filter-pills .btn:first-child').addEventListener('click', function() {
            const cards = document.querySelectorAll('.reservation-card');
            cards.forEach(card => card.style.display = 'block');
        });
    </script>
</body>
</html>
